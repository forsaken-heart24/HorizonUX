name: Cloud Build

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Select build target'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - a30

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Free disk space (1/3)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo docker builder prune -a

      - name: Free disk space (2/3)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true

      - name: Free disk space (3/3)
        uses: rokibhasansagar/slimhub_actions@main
        with:
          retain: 'compiler_cmake'

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Build ROM
        env:
        	BUGREPORTER_BOT_TOKEN: ${{ secrets.BUGREPORTER_BOT_TOKEN }}
        	CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          chmod +x ./workflow_builder/build_cloud.sh
          ./workflow_builder/build_cloud.sh --${{ github.event.inputs.target }}